<html>
<head>
<title>分布式温控系统房间空调</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<font id="title" size="6" color="#ffffff"><pre>                  房间空调控制面板</pre></font>
<body bgcolor="#666666" leftmargin="0" topmargin="0" marginwidth="300" marginheight="100" text-align:center>
<!-- Save for Web Slices (全蓝背景—切片1.psd) -->
<table id="__01" width="684" height="364" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td colspan="5">
            <div style="background:url(images/room4_01.gif) no-repeat;width:683px;height:48px;text-align:center;vertical-align:middle;line-height:48px">
                <b id="no">编号:</b>
                <b id="roomId"></b>
                <b>空调状态:</b>
                <b id="showState">停机</b>
            </div></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="48" alt=""></td>
    </tr>
    <tr>
        <td>
            <div style="background:url(images/room4_02.gif) no-repeat;width:153px;height:41px;text-align:center;vertical-align:middle;line-height:41px">
                <b id="currentTemp" >当前温度(度)</b>
            </div></td>
        <td>
            <div style="background:url(images/room4_03.gif) no-repeat;width:149px;height:41px;text-align:center;vertical-align:middle;line-height:41px">
                <b id="aimTemp" >目标温度(度)</b>
            </div></td>
        <td rowspan="3">
            <input id="btnUp" type="image" src="images/room4_04.gif" alt="" width="102" height="74"/></td>
        <td>
            <div style="background:url(images/room4_05.gif) no-repeat;width:172px;height:41px;text-align:center;vertical-align:middle;line-height:41px">
                <b id="speed" >风速</b>
            </div></td>
        <td rowspan="2">
            <input id="btnHigh" type="image" src="images/room4_06.gif" alt="" width="107" height="53" ></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="41" alt=""></td>
    </tr>
    <tr>
        <td rowspan="4">
            <div style="background:url(images/room4_07.gif) no-repeat;width:153px;height:119px;text-align:center;vertical-align:middle;line-height:119px">
                <font id="showCurrentTemp" size="6"></font>
            </div></td>
        <td rowspan="4">
            <div style="background:url(images/room4_08.gif) no-repeat;width:149px;height:119px;text-align:center;vertical-align:middle;line-height:119px">
                <font id="showAimTemp" size="6"></font>
            </div></td>
        <td rowspan="4">
            <div style="background:url(images/room4_09.gif) no-repeat;width:172px;height:119px;text-align:center;vertical-align:middle;line-height:119px">
                <font id="showSpeed" size="6"></font>
            </div></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="12" alt=""></td>
    </tr>
    <tr>
        <td rowspan="2">
            <input id="btnM" type="image" src="images/room4_10.gif" alt="" width="107" height="51"></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="21" alt=""></td>
    </tr>
    <tr>
        <td rowspan="2">
            <input id="btnDown" type="image" src="images/room4_11.gif" alt="" width="102" height="86"></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="30" alt=""></td>
    </tr>
    <tr>
        <td>
            <input id="btnLow" type="image" src="images/room4_12.gif" alt="" width="107" height="56"></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="56" alt=""></td>
    </tr>
    <tr>
        <td>
            <div style="background:url(images/room4_13.gif) no-repeat;width:153px;height:38px;text-align:center;vertical-align:middle;line-height:38px">
                <b id="mode" >工作模式</b>
            </div></td>
        <td>
            <div style="background:url(images/room4_14.gif) no-repeat;width:149px;height:38px;text-align:center;vertical-align:middle;line-height:38px">
                <b id="cost" >当前消费(元)</b>
            </div></td>
        <td rowspan="2">
            <input id="btnLook" type="image" src="images/room4_15.gif" alt="" width="102" height="156"></td>
        <td colspan="2" rowspan="2">
            <input id="btnOnOff" type="image" src="images/room4_16.gif" alt="" width="279" height="156"></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="38" alt=""></td>
    </tr>
    <tr>
        <td>
            <div style="background:url(images/room4_17.gif) no-repeat;width:153px;height:118px;text-align:center;vertical-align:middle;line-height:118px">
                <font id="showMode" size="6"></font>
            </div></td>
        <td>
            <div style="background:url(images/room4_18.gif) no-repeat;width:149px;height:118px;text-align:center;vertical-align:middle;line-height:118px">
                <font id="showCost" size="6"></font>
            </div></td>
        <td>
            <img src="images/&#x5206;&#x9694;&#x7b26;.gif" width="1" height="118" alt=""></td>
    </tr>
</table>
<!-- End Save for Web Slices -->
</body>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript">
    var max_temp = 33;  //调节温度的最大温度
    var min_temp = 22;  //调节温度的最小温度
    var current_temp = 26; //房间默认的当前温度
    var ROOM_ID = 303;
    var STATE_OFF = 0;
    var STATE_ON = 1;
    var STATE_WAIT = 2;     // 待机：本地调控
    var MODE_COLD = 0;      // 制冷模式
    var MODE_HOT = 1;       // 制热模式
    var SPEED_LOW = 0;
    var SPEED_M = 1;
    var SPEED_HIGH = 2;
    var host = "http://localhost:3000/room";
    var t;
    $('#roomId').text(ROOM_ID);

    window.min_temp = min_temp;
    window.max_temp = max_temp;

    function toShowMode(mode) {
        if (mode == MODE_COLD) {
            return '制冷';
        }
        else if (mode == MODE_HOT) {
            return '制暖';
        }
    }
    function toShowState(state) {
        if (state == STATE_OFF) {
            return '停机';
        }
        else if(state == STATE_ON) {
            return '运行';
        }
        else if (state == STATE_WAIT) {
            return '待机';
        }
    }
    function toShowSpeed(speed) {
        if (speed == SPEED_LOW) {
            return '低风';
        }
        else if(speed == SPEED_M) {
            return '中风';
        }
        else if (speed == SPEED_HIGH) {
            return '高风';
        }
    }
    function toGetMode() {
        var showmode = $('#showMode').text();
        if (showmode == '制冷') {
            return MODE_COLD;
        }
        else if (showmode == '制暖') {
            return MODE_HOT;
        }
    }
    function toGetState() {
        var showstate = $('#showState').text();
        if (showstate == '停机') {
            return STATE_OFF;
        }
        else if(showstate == '运行') {
            return STATE_ON;
        }
        else if (showstate == '待机') {
            return STATE_WAIT;
        }
    }
    function toGetSpeed() {
        var showspeed = $('#showSpeed').text();
        if (showspeed == '低风') {
            return SPEED_LOW;
        }
        else if(showspeed == '中风') {
            return SPEED_M;
        }
        else if (showspeed == '高风') {
            return SPEED_HIGH;
        }
    }


/* ============ 本地空调进入待机状态时的温度变化策略： ================*/
    //房间空调待机时温度变化
    var t1, t;              // 突然停机时停止调度
    function sacTempChange() {
        $('#showState').text(toGetState(STATE_WAIT));  //状态修改为待机

        var target = parseInt($('#showAimTemp').text());
        var temp = parseInt($('#showCurrentTemp').text());
        t1 = setInterval(function(){
            if(Math.abs(temp - target) < 1) {   //小于1度
                if (toGetMode() == 0) {
                    temp+=0.05;
                }
                else {
                    temp-=0.05;
                }
                $('#showCurrentTemp').text(temp.toFixed(2));
            }
            // 达到临界温度，交由主控机调度
            else {
                clearInterval(t1);

                var data = {
                    room_id :ROOM_ID,
                    temp: temp
                };
                $.post(
                    host+"/changed",
                    JSON.stringify(data),
                    function(data,status){
                        alert(data);
                        var getData = JSON.parse(data);
                        if (getData.code != 0) {
                        }
                    });

                sendChangeTemp(target);
            }
        }, 2000);
    }

/* =============== 交由主控机进行温度调度： ================ */
    //发送温度请求
    // 温控请求设置为每隔6s请求一次
    function sendChangeTemp(temp) {
        var data = {
            room_id: ROOM_ID,
            target: temp,
            speed: toGetSpeed()
        };
        var t= setInterval(function(){
            $.post(
            host+"/run",
            JSON.stringify(data),
            function(data, status){
                var getData = JSON.parse(data);
                //升温请求返回操作
                switch(getData.code){
                    //温度请求失败
                    case 0:
                        clearInterval(t);
                        alert('温控请求失败: err: '+getData.err);
                        break;
                    // 正常情况
                    case 1:
                        $('#showCurrentTemp').text(getData.data.temp.toFixed(2));
                        $('#showCost').text(getData.data.cost.toFixed(2));
                        $('#showState').text(toShowState(getData.data.status));
                        break;
                    // 已达到目标温度，禁止请求，同时开启本地温度调控
                    case -1:
                        $('#showCurrentTemp').text(getData.data.temp.toFixed(2));
                        $('#showCost').text(getData.data.cost.toFixed(2));
                        clearInterval(t);
                        alert("已达到目标温度，开启本地温度调控");
                        $('#showState').text(toShowState(getData.data.status));
                        sacTempChange();
                        break;
                    case 3:
                        alert("进入调度队列排队状态");
                        $('#showState').text("等待中央空调调度中");
                        break;
                    default:
                        alert("返回的code不合法");
                }
            });
        }, 6000);
    }


    //点击开关按钮
    $('#btnOnOff').click(function(){
        if (toGetState() == STATE_OFF) {
            var data_on = {
                room_id: ROOM_ID,
                temp: current_temp,
                state: STATE_ON
                //temp: parseInt($('#showCurrentTemp').text())
            };
            $.post(
                host+"/handshake",
                JSON.stringify(data_on),
                function(data, status){
                    //alert(data);
                    var getData = JSON.parse(data);
                    if(getData.code != 0){
                        min_temp = getData.data.min_temp;  //保存调节温度的最小值
                        max_temp = getData.data.max_temp;  //保存调节温度的最大值
                        $('#showMode').text(toShowMode(getData.data.mode));//显示工作模式
                        $('#showAimTemp').text(getData.data.target); //显示缺省目标温度
                        $('#showCurrentTemp').text(current_temp); //显示当前设置的默认温度
                        $('#showState').text(toShowState(getData.data.status));//显示房间空调状态
                        $('#showSpeed').text(toShowSpeed(getData.data.speed));//显示默认风速
                        current_temp = $('#showCurrentTemp').text();
                        if (getData.data.target_temp == current_temp) {
                            //启动房间空调温度变化函数
                            sacTempChange();
                        }
                        else {
                            //向中央空调发送温控请求
                            sendChangeTemp(getData.data.target_temp);
                        }
                    }
                    else {
                        alert("中央空调开机请求错误！");
                    }
                });
        }
        else {
            var data_off = {
                room_id: ROOM_ID,
                state: STATE_OFF
                //temp: parseInt($('#showCurrentTemp').text())
            };
            clearInterval(t1);
            clearInterval(t);
            $.post(
                host+"/shutdown",
                JSON.stringify(data_off),
                function(data, status){
                    alert(data);
                    var getData = JSON.parse(data);
                    if(getData.code != 0){
                        $('#showMode').text("");//显示工作模式为空
                        $('#showAimTemp').text(""); //显示目标温度为空
                        $('#showCurrentTemp').text(""); //显示当前温度为空
                        $('#showState').text(toShowState(STATE_OFF));//显示房间状态为停机
                        $('#showSpeed').text("");//显示风速为空
                    }
                    else {
                        alert("中央空调关机请求响应错误！");
                    }
                });
        }

    });

    //发送风速请求
    function changeSpeed(s){
        var data = {
            room_id: ROOM_ID,
            speed: s
        };
        $.post(
            host+"/setSpeed",
            JSON.stringify(data),
            function(data,status){
                alert(data);
                var getData = JSON.parse(data);
                //风速请求返回操作
                if (getData.code != 0) {
                    $('#showSpeed').text(toShowSpeed(s));
                }
                else {
                    //返回不成功，不做操作
                    alert('风速请求失败');
                }

            }
            );
    }
    // 发送改变温度请求：
    //发送风速请求
    function changeTemp(t){
        var data = {
            room_id: ROOM_ID,
            target:t
        };
        $.post(
            host+"/setTemp",
            JSON.stringify(data),
            function(data){
                alert(data, status);
                var getData = JSON.parse(data);
                //风速请求返回操作
                if (getData.code != 0) {
                    $('#showSpeed').text(toShowSpeed(s));
                }
                else {
                    //返回不成功，不做操作
                    alert('风速请求失败');
                }

            }
            );
    }
    //点击风速（高）按钮
    $('#btnHigh').click(function(){
        if (toGetState() != STATE_OFF) {
            var speed = toGetSpeed();
            if(speed != SPEED_HIGH){
                changeSpeed(SPEED_HIGH);
            }
        }
    });

    //点击风速（中）按钮
    $('#btnM').click(function(){
        if (toGetState() != STATE_OFF) {
            var speed = toGetSpeed();
            if(speed != SPEED_M){
                changeSpeed(SPEED_M);
            }
        }
    });

    //点击风速（低）按钮
    $('#btnLow').click(function(){
        if (toGetState() != STATE_OFF) {
            var speed = toGetSpeed();
            if(speed != SPEED_LOW){
                changeSpeed(SPEED_LOW);
            }
        }
    });

    //点击查看当前消费金额按钮
    // $('#btnLook').click(function(){
    //     if (toGetState() != STATE_OFF) {
    //         var data = {
    //             room_id: ROOM_ID
    //         };
    //         $.post(
    //             host+"/checkCost",
    //                 JSON.stringify(data),
    //                 function(data, status) {
    //                     alert(data);
    //                     var getData = JSON.parse(data);
    //                     if (getData.code != 0) {

    //                     }
    //                     //返回信息判断，进行金额显示
    //                 }
    //             );
    //     }
    // });

    //点击升温按钮
    $('#btnUp').click(function(){
        //1s内发送最后一次，超过1s发送多次，1s内的需要在本地显示目标温度的变化，只是请求最后一次
        //温度值判断，是否超出范围
        var temp = $('#showCurrentTemp').text();
        var target_temp = $('#showAimTemp').text();
        target_temp++;
        if((target_temp > temp && toGetMode()==0) || (target_temp < temp && toGetMode() == 1)){
            alert('该模式下目标温度与当前温度已接近适宜，无需调控');
        }
        else if (target_temp >= window.min_temp && target_temp <= window.max_temp) {
            $('#showAimTemp').text(target_temp); //在发送前显示还是接受后？？？
            changeTemp(target_temp);
            //alert(temp);
        }
        else {
            alert('已超出调节温度范围');
        }
    });

    //点击降温按钮
    $('#btnDown').click(function(){
        //1s内发送最后一次，超过1s发送多次，1s内的需要在本地显示目标温度的变化，只是请求最后一次
        //温度值判断，是否超出范围
        var temp = $('#showCurrentTemp').text();
        var target_temp = $('#showAimTemp').text();
        target_temp--;
        if((target_temp > temp && toGetMode()==0) || (target_temp < temp && toGetMode() == 1)){
            alert('该模式下目标温度与当前温度已接近适宜，无需调控');
        }
        else if (target_temp >= window.min_temp && target_temp <= window.max_temp) {
            $('#showAimTemp').text(target_temp); //在发送前显示还是接受后？？？
            changeTemp(target_temp);
            //alert(temp);
        }
        else {
            alert('已超出调节温度范围');
        }
    });

    //对升温降温按钮同时作用
    // var dateObj = new Date();
    // var time_click_changeTemp = dateObj.getMilliseconds(); //返回毫秒数
    //var time_click_changeTemp = 0;
    //1s内发送最后一次，超过1s发送多次，1s内的需要在本地显示目标温度的变化，只是请求最后一次
    //点击升温按钮
    // $('#btnUp').click(function(){
    //  var date = new Date();
    //  var nowSeconds = date.getMilliseconds();
 //        var temp = $('#showAimTemp').text();
 //        temp++;
 //        if (isInTempRane(temp)) {
 //         if (nowSeconds - time_click_changeTemp < 1000) {
 //             //alert(nowSeconds);
 //             //alert(time_click_changeTemp);
 //             $('#showAimTemp').text(temp);
    //      }
    //      else {
    //          time_click_changeTemp = nowSeconds;
 //             alert(temp);
 //             //sendChangeTemp(temp);
 //             }
 //        }
 //        else {
 //            alert('已超出调节温度范围');
 //        }
    // });

    // //点击降温按钮
    // $('#btnDown').click(function(){
    //  var date = new Date();
 //        var nowSeconds = date.getMilliseconds();
 //        var temp = $('#showAimTemp').text();
 //        temp--;
 //        if (isInTempRane(temp)) {
 //         if (nowSeconds - time_click_changeTemp < 1000) {
 //             $('#showAimTemp').text(temp);
    //      }
    //      else {
    //          time_click_changeTemp = nowSeconds;
 //             alert(temp);
 //             //sendChangeTemp(temp);
 //             }
 //        }
 //        else {
 //         alert('已超出调节温度范围');
 //        }
    // });

</script>
</html>